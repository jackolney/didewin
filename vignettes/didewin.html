<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="author" content="Rich FitzJohn" />

<meta name="date" content="2016-05-27" />

<title>R and the DIDE cluster</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; }
code > span.dt { color: #902000; }
code > span.dv { color: #40a070; }
code > span.bn { color: #40a070; }
code > span.fl { color: #40a070; }
code > span.ch { color: #4070a0; }
code > span.st { color: #4070a0; }
code > span.co { color: #60a0b0; font-style: italic; }
code > span.ot { color: #007020; }
code > span.al { color: #ff0000; font-weight: bold; }
code > span.fu { color: #06287e; }
code > span.er { color: #ff0000; font-weight: bold; }
</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>


<link href="data:text/css,body%20%7B%0A%20%20background%2Dcolor%3A%20%23fff%3B%0A%20%20margin%3A%201em%20auto%3B%0A%20%20max%2Dwidth%3A%20700px%3B%0A%20%20overflow%3A%20visible%3B%0A%20%20padding%2Dleft%3A%202em%3B%0A%20%20padding%2Dright%3A%202em%3B%0A%20%20font%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0A%20%20font%2Dsize%3A%2014px%3B%0A%20%20line%2Dheight%3A%201%2E35%3B%0A%7D%0A%0A%23header%20%7B%0A%20%20text%2Dalign%3A%20center%3B%0A%7D%0A%0A%23TOC%20%7B%0A%20%20clear%3A%20both%3B%0A%20%20margin%3A%200%200%2010px%2010px%3B%0A%20%20padding%3A%204px%3B%0A%20%20width%3A%20400px%3B%0A%20%20border%3A%201px%20solid%20%23CCCCCC%3B%0A%20%20border%2Dradius%3A%205px%3B%0A%0A%20%20background%2Dcolor%3A%20%23f6f6f6%3B%0A%20%20font%2Dsize%3A%2013px%3B%0A%20%20line%2Dheight%3A%201%2E3%3B%0A%7D%0A%20%20%23TOC%20%2Etoctitle%20%7B%0A%20%20%20%20font%2Dweight%3A%20bold%3B%0A%20%20%20%20font%2Dsize%3A%2015px%3B%0A%20%20%20%20margin%2Dleft%3A%205px%3B%0A%20%20%7D%0A%0A%20%20%23TOC%20ul%20%7B%0A%20%20%20%20padding%2Dleft%3A%2040px%3B%0A%20%20%20%20margin%2Dleft%3A%20%2D1%2E5em%3B%0A%20%20%20%20margin%2Dtop%3A%205px%3B%0A%20%20%20%20margin%2Dbottom%3A%205px%3B%0A%20%20%7D%0A%20%20%23TOC%20ul%20ul%20%7B%0A%20%20%20%20margin%2Dleft%3A%20%2D2em%3B%0A%20%20%7D%0A%20%20%23TOC%20li%20%7B%0A%20%20%20%20line%2Dheight%3A%2016px%3B%0A%20%20%7D%0A%0Atable%20%7B%0A%20%20margin%3A%201em%20auto%3B%0A%20%20border%2Dwidth%3A%201px%3B%0A%20%20border%2Dcolor%3A%20%23DDDDDD%3B%0A%20%20border%2Dstyle%3A%20outset%3B%0A%20%20border%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0A%20%20border%2Dwidth%3A%202px%3B%0A%20%20padding%3A%205px%3B%0A%20%20border%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0A%20%20border%2Dwidth%3A%201px%3B%0A%20%20border%2Dstyle%3A%20inset%3B%0A%20%20line%2Dheight%3A%2018px%3B%0A%20%20padding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0A%20%20border%2Dleft%2Dstyle%3A%20none%3B%0A%20%20border%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0A%20%20background%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0A%0Ap%20%7B%0A%20%20margin%3A%200%2E5em%200%3B%0A%7D%0A%0Ablockquote%20%7B%0A%20%20background%2Dcolor%3A%20%23f6f6f6%3B%0A%20%20padding%3A%200%2E25em%200%2E75em%3B%0A%7D%0A%0Ahr%20%7B%0A%20%20border%2Dstyle%3A%20solid%3B%0A%20%20border%3A%20none%3B%0A%20%20border%2Dtop%3A%201px%20solid%20%23777%3B%0A%20%20margin%3A%2028px%200%3B%0A%7D%0A%0Adl%20%7B%0A%20%20margin%2Dleft%3A%200%3B%0A%7D%0A%20%20dl%20dd%20%7B%0A%20%20%20%20margin%2Dbottom%3A%2013px%3B%0A%20%20%20%20margin%2Dleft%3A%2013px%3B%0A%20%20%7D%0A%20%20dl%20dt%20%7B%0A%20%20%20%20font%2Dweight%3A%20bold%3B%0A%20%20%7D%0A%0Aul%20%7B%0A%20%20margin%2Dtop%3A%200%3B%0A%7D%0A%20%20ul%20li%20%7B%0A%20%20%20%20list%2Dstyle%3A%20circle%20outside%3B%0A%20%20%7D%0A%20%20ul%20ul%20%7B%0A%20%20%20%20margin%2Dbottom%3A%200%3B%0A%20%20%7D%0A%0Apre%2C%20code%20%7B%0A%20%20background%2Dcolor%3A%20%23f7f7f7%3B%0A%20%20border%2Dradius%3A%203px%3B%0A%20%20color%3A%20%23333%3B%0A%7D%0Apre%20%7B%0A%20%20white%2Dspace%3A%20pre%2Dwrap%3B%20%20%20%20%2F%2A%20Wrap%20long%20lines%20%2A%2F%0A%20%20border%2Dradius%3A%203px%3B%0A%20%20margin%3A%205px%200px%2010px%200px%3B%0A%20%20padding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0A%20%20background%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0A%0Acode%20%7B%0A%20%20font%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0A%20%20font%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0A%20%20padding%3A%202px%200px%3B%0A%7D%0A%0Adiv%2Efigure%20%7B%0A%20%20text%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0A%20%20background%2Dcolor%3A%20%23FFFFFF%3B%0A%20%20padding%3A%202px%3B%0A%20%20border%3A%201px%20solid%20%23DDDDDD%3B%0A%20%20border%2Dradius%3A%203px%3B%0A%20%20border%3A%201px%20solid%20%23CCCCCC%3B%0A%20%20margin%3A%200%205px%3B%0A%7D%0A%0Ah1%20%7B%0A%20%20margin%2Dtop%3A%200%3B%0A%20%20font%2Dsize%3A%2035px%3B%0A%20%20line%2Dheight%3A%2040px%3B%0A%7D%0A%0Ah2%20%7B%0A%20%20border%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0A%20%20padding%2Dtop%3A%2010px%3B%0A%20%20padding%2Dbottom%3A%202px%3B%0A%20%20font%2Dsize%3A%20145%25%3B%0A%7D%0A%0Ah3%20%7B%0A%20%20border%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0A%20%20padding%2Dtop%3A%2010px%3B%0A%20%20font%2Dsize%3A%20120%25%3B%0A%7D%0A%0Ah4%20%7B%0A%20%20border%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0A%20%20margin%2Dleft%3A%208px%3B%0A%20%20font%2Dsize%3A%20105%25%3B%0A%7D%0A%0Ah5%2C%20h6%20%7B%0A%20%20border%2Dbottom%3A%201px%20solid%20%23ccc%3B%0A%20%20font%2Dsize%3A%20105%25%3B%0A%7D%0A%0Aa%20%7B%0A%20%20color%3A%20%230033dd%3B%0A%20%20text%2Ddecoration%3A%20none%3B%0A%7D%0A%20%20a%3Ahover%20%7B%0A%20%20%20%20color%3A%20%236666ff%3B%20%7D%0A%20%20a%3Avisited%20%7B%0A%20%20%20%20color%3A%20%23800080%3B%20%7D%0A%20%20a%3Avisited%3Ahover%20%7B%0A%20%20%20%20color%3A%20%23BB00BB%3B%20%7D%0A%20%20a%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0A%20%20%20%20text%2Ddecoration%3A%20underline%3B%20%7D%0A%20%20a%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0A%20%20%20%20text%2Ddecoration%3A%20underline%3B%20%7D%0A%0A%2F%2A%20Class%20described%20in%20https%3A%2F%2Fbenjeffrey%2Ecom%2Fposts%2Fpandoc%2Dsyntax%2Dhighlighting%2Dcss%0A%20%20%20Colours%20from%20https%3A%2F%2Fgist%2Egithub%2Ecom%2Frobsimmons%2F1172277%20%2A%2F%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%2F%2A%20Keyword%20%2A%2F%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%2F%2A%20DataType%20%2A%2F%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%2F%2A%20DecVal%20%28decimal%20values%29%20%2A%2F%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%2F%2A%20BaseN%20%2A%2F%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%2F%2A%20Float%20%2A%2F%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%2F%2A%20Char%20%2A%2F%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%2F%2A%20String%20%2A%2F%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%2F%2A%20Comment%20%2A%2F%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%2F%2A%20OtherToken%20%2A%2F%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%2F%2A%20AlertToken%20%2A%2F%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%2F%2A%20Function%20calls%20%2A%2F%20%0Acode%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%2F%2A%20ErrorTok%20%2A%2F%0A%0A" rel="stylesheet" type="text/css" />

</head>

<body>



<div id="header">
<h1 class="title">R and the DIDE cluster</h1>
<h4 class="author"><em>Rich FitzJohn</em></h4>
<h4 class="date"><em>2016-05-27</em></h4>
</div>

<div id="TOC">
<ul>
<li><a href="#functions">Functions</a></li>
<li><a href="#filesystems">Filesystems</a></li>
<li><a href="#getting-started">Getting started</a><ul>
<li><a href="#configuration">Configuration</a></li>
<li><a href="#contexts">Contexts</a></li>
<li><a href="#creating-the-queue">Creating the queue</a></li>
<li><a href="#testing-that-the-queue-works-correctly">Testing that the queue works correctly</a></li>
<li><a href="#running-single-jobs">Running single jobs</a></li>
<li><a href="#running-many-jobs">Running many jobs</a></li>
<li><a href="#cancelling-and-stopping-jobs">Cancelling and stopping jobs</a></li>
</ul></li>
<li><a href="#misc">Misc</a><ul>
<li><a href="#jobs-that-require-compiled-code">Jobs that require compiled code</a></li>
<li><a href="#parallel-computation-on-the-cluster">Parallel computation on the cluster</a></li>
<li><a href="#rstan"><code>rstan</code></a></li>
<li><a href="#using-microsoft-hpc-tools">Using Microsoft HPC tools</a></li>
</ul></li>
<li><a href="#mapping-network-drives">Mapping network drives</a><ul>
<li><a href="#windows">Windows</a></li>
<li><a href="#mac-osx">Mac OS/X</a></li>
<li><a href="#linux">Linux</a></li>
</ul></li>
<li><a href="#running-out-of-place">Running out of place</a></li>
<li><a href="#installation">Installation</a></li>
</ul>
</div>

<p>Parallel computing on a cluster can be more challenging than running things locally because it’s often the first time that you need to package up code to run elsewhere, and when things go wrong it’s more difficult to get information on why things failed.</p>
<p>Much of the difficulty of getting things running involves working out what your code depends on, and getting that installed in the right place on a computer that you can’t physically poke at. The next set of problems is dealing with the balloning set of files that end up being created - templates, scripts, output files, etc.</p>
<p>This set of packages (<code>didewin</code>, <code>queuer</code> and <code>context</code>, along with a couple of support packages) aims to remove the pain of getting everything set up, and in keeping cluster tasks running.</p>
<p>Once everything is set up, running a job on the cluster should be as straightforward as running things locally.</p>
<p>The documentation here runs through a few of the key concepts, then walks through setting this all up. There’s also a “quick start” guide that contains much less discussion.</p>
<div id="functions" class="section level2">
<h2>Functions</h2>
<p>The biggest conceptual move is from thinking about running <strong>scripts</strong> that generate <em>files</em> to running <strong>functions</strong> that return <em>objects</em>. The reason for this is that gives a well defined interface to build everything else around.</p>
<p>The problem with scripts is that they might do almost anything. They depend on untold files and packages which they load wherever. The produce any number of objects. That’s fine, but it becomes hard to reason about them to plan deploying them elsewhere, to capture the outputs appropriately, or to orchestrate looping over a bunch of paramter values. If you’ve found yourself writing a number of script files changing values with text substitution you have run into this.</p>
<p>In contrast, functions do (ideally) one thing. They have a well defined set of inputs (their arguments) and outputs (their return value). We can loop over a range of input values by iterating over a set of arguments.</p>
<p>This set of packages tends to work best if you let it look after filenames. Rather than trying to come up with a naming scheme for different files as based on parameter values, just return objects and the packages will arrange for them to be saved and reloaded.</p>
</div>
<div id="filesystems" class="section level2">
<h2>Filesystems</h2>
<p>The DIDE cluster needs everything to be available on a filesystem that the cluster can read. Practically this means the filesystems //fi–didef2/tmp<code>or</code>//fi–san02/homes/username<code>and the like. You probably have access to network shares that are specific to a project, too.  For Windows users these are probably mapped to drives (</code>Q:<code>or</code>T:` or similar) already, but for other platforms you will need to do a little extra work to get things set up (see below).</p>
<p>It is simplest if <em>everything</em> that is needed for a project is present in a single directory that is visible on the cluster. However, other patterns are possible; see “Running out of place” towards the bottom of this page.</p>
<p>However for the most of this document I will assume that everything is in one directory, which is on a network share.</p>
</div>
<div id="getting-started" class="section level1">
<h1>Getting started</h1>
<p>The initial setup will feel like a headache at first, but it should ultimately take only a few lines. Once everything is set up, then the payback is that is the job submission part will become a lot simpler.</p>
<div id="configuration" class="section level2">
<h2>Configuration</h2>
<p>The configuration is handled in a two stage process. First, some bits that are machine specific are set using <code>didewin::didewin_config_global</code>, which also looks in a number of of R’s options. Then when a queue is created, further values can be passed along via the <code>config</code> argument that will use the “global” options as a default.</p>
<p>The reason for this separation is that ideally the machine-specific options will not end up in scripts, because that makes things less portable (for example,we need to get your username, but your username is unlikely to work for your collaborators).</p>
<p>Ideally in your ~/.Rprofile file, you will add something like:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">options</span>(
  <span class="dt">didewin.username=</span><span class="st">&quot;rfitzjoh&quot;</span>,
  <span class="dt">didewin.home=</span><span class="st">&quot;~/net/home&quot;</span>)</code></pre>
<p>and then set only options (such as cluster and cores or template) that vary with a project.</p>
<p>At the moment (while things change) it might be simplest to set things using the <code>didewin::didewin_config_global</code> function. The help file <code>?didewin::didewin_config</code> outlines the options here. At the moment a minimal set of options is your credentials (not needed on Windows domain machines) and the cluster you wish to use (if you don’t want to use the small cluster).</p>
<div id="credentials" class="section level3">
<h3>Credentials</h3>
<p>If you have a Linux system and have configured your smb mounts as described below, you might as well take advantage of this and set <code>credentials=&quot;~/.smbcredentials&quot;</code> and you will never be prompted for your password:</p>
<pre class="sourceCode r"><code class="sourceCode r">didewin::<span class="kw">didewin_config_global</span>(<span class="dt">credentials=</span><span class="st">&quot;~/.smbcredentials&quot;</span>)</code></pre>
<p>Mac users will need to provide their username here.</p>
<pre class="sourceCode r"><code class="sourceCode r">didewin::<span class="kw">didewin_config_global</span>(<span class="dt">credentials=</span><span class="st">&quot;yourusername&quot;</span>)</code></pre>
<p>Windows users will not need to provide anything unless they are on a non-domain machine.</p>
</div>
<div id="additional-shares" class="section level3">
<h3>Additional shares</h3>
<p>If you refer to network shares in your functions, e.g., to refer to data, you’ll need to map these too. To do that, pass them as the <code>shares</code> argument to <code>didewin_config_global</code>.</p>
<p>To describe each share, use the <code>didewin::path_mapping</code> function which takes arguments:</p>
<ul>
<li>name: a desctiptive name for the share</li>
<li><code>path_local</code>: the point where the share is mounted on your computer</li>
<li><code>path_remote</code>: the network path that the share refers to (forward slashes are much easier to enter here than backward slashes)</li>
<li><code>drive_remote</code>: the drive this should be mapped to on the cluster.</li>
</ul>
<p>So to map your “M drive” to which points at <code>\\fi--didef2\malaria</code> to <code>M:</code> on the cluster you can write</p>
<pre class="sourceCode r"><code class="sourceCode r">share &lt;-<span class="st"> </span>didewin::<span class="kw">path_mapping</span>(<span class="st">&quot;malaria&quot;</span>, <span class="st">&quot;M:&quot;</span>, <span class="st">&quot;//fi--didef2/malaria&quot;</span>, <span class="st">&quot;M:&quot;</span>)
didewin::<span class="kw">didewin_config_global</span>(<span class="dt">shares=</span>share)</code></pre>
<p>If you have more than one share to map, pass them through as a list.</p>
</div>
<div id="seeing-the-default-configuration" class="section level3">
<h3>Seeing the default configuration</h3>
<p>To see the configuration that will be run if you don’t do anything (else), run:</p>
<pre class="sourceCode r"><code class="sourceCode r">didewin::<span class="kw">didewin_config</span>()</code></pre>
<pre><code>## &lt;didewin_config&gt;
##  - cluster: fi--didemrchnb
##  - credentials: ~/.smbcredentials
##  - username: rfitzjoh
##  - build_server: 129.31.25.12
##  - template: GeneralNodes
##  - hpctools: FALSE
##  - resource:
##     - parallel: FALSE
##     - count: 1
##     - type: Cores
##  - shares:
##     - home: (local) /home/rich/net/home =&gt; //fi--san02/homes/rfitzjoh =&gt; Q: (remote)
##     - temp: (local) /home/rich/net/temp =&gt; //fi--didef2/tmp =&gt; T: (remote)</code></pre>
<p>In here you can see the cluster (here, <code>fi--didemrchnb</code>), credentials and username, the job template (<code>GeneralNodes</code>), information about the resources that will be requested (1 core) and information on filesystem mappings. There are a few other bits of information that may be explained further down.</p>
</div>
</div>
<div id="contexts" class="section level2">
<h2>Contexts</h2>
<p>To recreate your work environment on the cluster, we use a package called <code>context</code>. This package uses the assumption that most working environments can be recreated by a combination of R packages and sourcing a set of function definitions.</p>
<div id="root" class="section level3">
<h3>Root</h3>
<p>Every context has a “root”; this is the directory that everything will be saved in. Most of the examples in the help use <code>contexts</code> which is fairly self explanatory but it can be any directory. Generally it will be in the current directory.</p>
<pre class="sourceCode r"><code class="sourceCode r">root &lt;-<span class="st"> &quot;contexts&quot;</span></code></pre>
</div>
<div id="packages" class="section level3">
<h3>Packages</h3>
<p>If you list packages as a character vector then all packages will be installed for you, and they will also be <em>attached</em>; this is what happens when you use the function <code>library()</code> So for example if you need to depend on the <code>rstan</code> and <code>ape</code> packages you could write:</p>
<pre class="sourceCode r"><code class="sourceCode r">ctx &lt;-<span class="st"> </span>context::<span class="kw">context_save</span>(root, <span class="dt">packages=</span><span class="kw">c</span>(<span class="st">&quot;rstan&quot;</span>, <span class="st">&quot;ape&quot;</span>))</code></pre>
<p>Attaching packages is not always what is wanted, especially if you have packages that clobber functions in base packages (e.g., <code>dplyr</code>!). An alternative is to list a set of packages that you want installed and split them into packages you would like attached and packages you would only like loaded:</p>
<pre class="sourceCode r"><code class="sourceCode r">ctx &lt;-<span class="st"> </span>context::<span class="kw">context_save</span>(root,
                             <span class="dt">packages=</span><span class="kw">list</span>(<span class="dt">loaded=</span><span class="st">&quot;geiger&quot;</span>, <span class="dt">attached=</span><span class="st">&quot;ape&quot;</span>))</code></pre>
<p>In this case, the packages in the <code>loaded</code> section will be installed (along with their dependencies) and before anything runs, we will run <code>loadNamespace</code> on them to confirm that they are properly available. Access functions in this package with the double-colon operator, like <code>geiger::fitContinuous</code>. However they will not be attached so will not modify the search path.</p>
<p>In contrast, packages listed in <code>attached</code> will be loaded with <code>library</code> so they will be available without qualification (e.g., <code>read.tree</code> rather than <code>ape::read.tree</code>).</p>
</div>
<div id="source-files-for-function-definitions" class="section level3">
<h3>Source files for function definitions</h3>
<p>If you define any of your own functions you will need to tell the cluster about them. The easiest way to do this is to save them in a file that contains only function definitions (and does not read data, etc).</p>
<p>For example, I have a file <code>mysources.R</code> with a very simple tree simulation in it. Imagine this is some slow function that given an integer <code>nspp</code> after a bunch of calculation yields a tree with <code>nspp</code> tips:</p>
<pre class="sourceCode r"><code class="sourceCode r">make_tree &lt;-<span class="st"> </span>function(nspp) {
  <span class="kw">message</span>(<span class="st">&quot;I am building a tree!&quot;</span>)
  ape::<span class="kw">rtree</span>(nspp)
}</code></pre>
<p>To set this up, we’d write:</p>
<pre class="sourceCode r"><code class="sourceCode r">ctx &lt;-<span class="st"> </span>context::<span class="kw">context_save</span>(root, <span class="dt">packages=</span><span class="st">&quot;ape&quot;</span>, <span class="dt">sources=</span><span class="st">&quot;mysources.R&quot;</span>)</code></pre>
<p><code>sources</code> can be a character vector, <code>NULL</code> or <code>character(0)</code> if you have no sources, or just omit it as above.</p>
</div>
<div id="custom-packages" class="section level3">
<h3>Custom packages</h3>
<p>If you depend on packages that are not on CRAN (e.g., your personal research code) you’ll need to tell <code>context</code> where to find them with its <code>package_sources</code> argument.</p>
<p>If the packages are on GitHub and public you can pass the github username/repo pair, in <code>devtools</code> style:</p>
<p>+eval=FALSE context::context_save(…, package_sources=context::package_sources(github=“richfitz/ids”))</p>
<p>Like with <code>devtools</code> you can use subdirectories, specific commits or tags in the specification.</p>
<p>If the packages are private, it is simplest to pass the path to where the package can be found on your computer with the <code>local</code> argument to <code>package_sources</code>.</p>
</div>
</div>
<div id="creating-the-queue" class="section level2">
<h2>Creating the queue</h2>
<p>The next step can take a little while so it’s useful to enable logging to see where things are up to:</p>
<pre class="sourceCode r"><code class="sourceCode r">context::<span class="kw">context_log_start</span>()</code></pre>
<p>Once a context has been created, we can create a queue with it. This is separate from the actual cluster queue, but will be our interface to it:</p>
<pre class="sourceCode r"><code class="sourceCode r">obj &lt;-<span class="st"> </span>didewin::<span class="kw">queue_didewin</span>(ctx)</code></pre>
<pre><code>## Loading context b7b2d57d4b3f6346d4d4f82fddb6040a</code></pre>
<pre><code>## [ context   ]  b7b2d57d4b3f6346d4d4f82fddb6040a</code></pre>
<pre><code>## [ library   ]  ape</code></pre>
<pre><code>## [ namespace ]</code></pre>
<pre><code>## [ source    ]  mysources.R</code></pre>
<pre><code>## [ cross     ]  checking available packages</code></pre>
<pre><code>## [ cross     ]  Downloading binary packages for: crayon, curl, digest, drat, memoise, R6, storr, uuid</code></pre>
<pre><code>## [ cross     ]  Cross installing source packages for: context</code></pre>
<pre><code>## [ cross     ]  checking available packages</code></pre>
<pre><code>## [ cross     ]  Downloading binary packages for: ape</code></pre>
<p>If the above command does not throw an error, then you have successfully logged in. When you run <code>queue_didewin</code> it will install windows versions of all required packages within the <code>root</code> directory (here, “contexts”). This is necessary even when you are on windows because the cluster cannot see files that are on your computer.</p>
<p><code>obj</code> is a weird sort of object called an <code>R6</code> class. It’s a bit like a Python or Java class if you’ve come from those languages. The thing you need to know is that the object is like a list and contains a number of functions that can be run by runing <code>obj$functionname()</code>. These functions all act by <em>side effect</em>; they interact with a little database stored in the context root directory or by communicating with the cluster using the web interface that Wes created.</p>
<pre class="sourceCode r"><code class="sourceCode r">obj</code></pre>
<pre><code>## &lt;queue_didewin&gt;
##   Inherits from: &lt;queue_base&gt;
##   Public:
##     clone: function (deep = FALSE)
##     cluster_load: function (cluster = NULL, nodes = TRUE)
##     config: didewin_config
##     context: context
##     context_envir: environment
##     db: environment
##     dide_id: function (t)
##     dide_log: function (t)
##     enqueue: function (expr, envir = parent.frame(), submit = TRUE, name = NULL)
##     enqueue_: function (expr, envir = parent.frame(), submit = TRUE, name = NULL)
##     initialise_context: function ()
##     initialize: function (context, config, initialise, rtools, sync)
##     logged_in: TRUE
##     login: function (always = TRUE)
##     root: contexts
##     set_cluster: function (cluster = NULL)
##     submit: function (task_ids, names = NULL)
##     submit_or_delete: function (task, name = NULL)
##     submit_workers: function (n)
##     sync: NULL
##     sync_files: function (verbose = TRUE, delete = TRUE)
##     task_bundle_get: function (id)
##     task_bundles_info: function ()
##     task_bundles_list: function ()
##     task_get: function (task_id)
##     task_result: function (task_id)
##     tasks_delete: function (task_ids)
##     tasks_list: function ()
##     tasks_status: function (task_ids = NULL, named = TRUE)
##     tasks_status_dide: function (task_ids = NULL)
##     tasks_times: function (task_ids = NULL, unit_elapsed = &quot;secs&quot;)
##     unsubmit: function (t)
##     workdir: /home/rich/net/home/cluster_test/vignette</code></pre>
<p>For example, to list the tasks that we know about:</p>
<pre class="sourceCode r"><code class="sourceCode r">obj$<span class="kw">tasks_list</span>()</code></pre>
<pre><code>## character(0)</code></pre>
<p>(of course there are no tasks yet because we haven’t added any). As a slightly more interesting example we can see how busy the cluster is:</p>
<pre class="sourceCode r"><code class="sourceCode r">obj$<span class="kw">cluster_load</span>()</code></pre>
<pre><code>##           name free used total
## -------------- ---- ---- -----
##  fi--didemrc06   12    0    12
##  fi--didemrc07   12    0    12
##  fi--didemrc08   10    2    12
##  fi--didemrc09    0   12    12
##  fi--didemrc10    0   12    12
##  fi--didemrc11   11    1    12
##  fi--didemrc12   12    0    12
##  fi--didemrc13   24    0    24
##  fi--didemrc14   24    0    24
##  fi--didemrc15   24    0    24
##  fi--didemrc16   24    0    24
##  fi--didemrc17    0   12    12
##  fi--didemrc18   12    0    12
##  fi--didemrc19   11    1    12
##  fi--didemrc20    8    4    12
##  fi--didemrc21    8    4    12
##  fi--didemrc22   11    1    12
##  fi--didemrc23    8    4    12
##  fi--didemrc24   12    0    12
##  fi--didemrc25   12    0    12
##  fi--didemrc26   12    0    12
##  fi--didemrc27   12    0    12
##  fi--didemrc28   12    0    12
##  fi--didemrc38   16    0    16
##  fi--didemrc39   16    0    16
##  fi--didemrc40   16    0    16
##  fi--didemrc41   16    0    16
##  fi--didemrc42   16    0    16
##  fi--didemrc43   16    0    16
##  fi--didemrc44   16    0    16
##  fi--didemrc45   16    0    16
##  fi--didemrc46   16    0    16
##  fi--didemrc47   16    0    16
##  fi--didemrc48   16    0    16
##  fi--didemrc49   16    0    16
##  fi--didemrc50   16    0    16
##  fi--didemrc51    0   20    20
##  fi--didemrc52    0   20    20
##  fi--didemrc53    0   20    20
##  fi--didemrc54    0   20    20
##  fi--didemrc55    0   20    20
##  fi--didemrc56    0   20    20
##  fi--didemrc57   20    0    20
##  fi--didemrc58   20    0    20
##  fi--didemrc59   20    0    20
##  fi--didemrc60   20    0    20
##  fi--didemrc61   20    0    20
##  fi--didemrc62   20    0    20
##  fi--didemrc63   20    0    20
##  fi--didemrc64   20    0    20
##  fi--didemrc65    0   32    32
##  fi--didemrc66    0   32    32
##  fi--didemrc67   24    0    24
##  fi--didemrc68   24    0    24
##  fi--didemrc69   24    0    24
##  fi--didemrc70   24    0    24
##  fi--didemrc71   24    0    24
##  fi--didemrc72   24    0    24
##  fi--didemrc73   24    0    24
##  fi--didemrc74   24    0    24
##  fi--didemrc75   16    0    16
##  fi--didemrc76   16    0    16
##  fi--didemrc77   16    0    16
##  fi--didemrc78   27    1    28
## -------------- ---- ---- -----
## fi--didemrchnb  906  238  1144</code></pre>
<p>(if you’re on a ANSI-compatible terminal this will be in glorious colour).</p>
</div>
<div id="testing-that-the-queue-works-correctly" class="section level2">
<h2>Testing that the queue works correctly</h2>
<p>Before running a real job, let’s test that everything works correctly by running the <code>sessionInfo</code> command on the cluster. When run locally, <code>sessionInfo</code> prints information about the state of your R session:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sessionInfo</span>()</code></pre>
<pre><code>## R version 3.3.0 (2016-05-03)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: Ubuntu 14.04.4 LTS
##
## locale:
##  [1] LC_CTYPE=en_GB.UTF-8       LC_NUMERIC=C
##  [3] LC_TIME=en_GB.UTF-8        LC_COLLATE=en_GB.UTF-8
##  [5] LC_MONETARY=en_GB.UTF-8    LC_MESSAGES=en_GB.UTF-8
##  [7] LC_PAPER=en_GB.UTF-8       LC_NAME=C
##  [9] LC_ADDRESS=C               LC_TELEPHONE=C
## [11] LC_MEASUREMENT=en_GB.UTF-8 LC_IDENTIFICATION=C
##
## attached base packages:
## [1] stats     graphics  grDevices utils     datasets  base
##
## other attached packages:
## [1] ape_3.4
##
## loaded via a namespace (and not attached):
##  [1] lattice_0.20-33  codetools_0.2-14 crayon_1.3.2     digest_0.6.9
##  [5] grid_3.3.0       context_0.0.8    R6_2.1.2         nlme_3.1-127
##  [9] storr_1.0.1      formatR_1.4      magrittr_1.5     evaluate_0.9
## [13] httr_1.1.0       stringi_1.0-1    curl_0.9.7       rematch_1.0.1
## [17] queuer_0.0.4     tools_3.3.0      stringr_1.0.0    didewin_0.0.3
## [21] knitr_1.13       methods_3.3.0</code></pre>
<p>To run this on the cluster, we wrap it in <code>obj$enqueue</code>. This prevents the evaluation of the expression and instead organises it to be run on the cluster:</p>
<pre class="sourceCode r"><code class="sourceCode r">t &lt;-<span class="st"> </span>obj$<span class="kw">enqueue</span>(<span class="kw">sessionInfo</span>())</code></pre>
<p>We can then poll the cluster for results until it completes:</p>
<pre class="sourceCode r"><code class="sourceCode r">t$<span class="kw">wait</span>(<span class="dv">100</span>)</code></pre>
<pre><code>## R version 3.2.4 Revised (2016-03-16 r70336)
## Platform: x86_64-w64-mingw32/x64 (64-bit)
## Running under: Windows Server 2012 R2 x64 (build 9600)
##
## locale:
## [1] LC_COLLATE=English_United Kingdom.1252
## [2] LC_CTYPE=English_United Kingdom.1252
## [3] LC_MONETARY=English_United Kingdom.1252
## [4] LC_NUMERIC=C
## [5] LC_TIME=English_United Kingdom.1252
##
## attached base packages:
## [1] methods   stats     graphics  grDevices utils     datasets  base
##
## other attached packages:
## [1] ape_3.5
##
## loaded via a namespace (and not attached):
## [1] R6_2.1.2        context_0.0.8   nlme_3.1-125    grid_3.2.4
## [5] digest_0.6.9    storr_1.0.1     lattice_0.20-33</code></pre>
<p>(see the next section for more information about this).</p>
<p>The important part to notice here is that the R “Platform” (second and third line) is Windows Server, as opposed to the host machine which is running Linux. In addition note that <code>ape</code> is lited under “other attached packages” and that <code>context</code>, as well as some other packages (<code>R6</code> <code>storr</code> and <code>digest</code> in particular) have been installed and are loaded (but not attached). This shows that the system has set up a working environment like our local one on the remote machine, and we can evaluate tasks in it!</p>
</div>
<div id="running-single-jobs" class="section level2">
<h2>Running single jobs</h2>
<p>Let’s run something more interesting now by running the <code>make_tree</code> function defined in the <code>mysources.R</code> file.</p>
<p>As above, jobs are queueed by running:</p>
<pre class="sourceCode r"><code class="sourceCode r">t &lt;-<span class="st"> </span>obj$<span class="kw">enqueue</span>(<span class="kw">make_tree</span>(<span class="dv">10</span>))</code></pre>
<p>Like the queue object, <code>obj</code>, task objects are R6 objects that can be used to get information and results back from the task.</p>
<pre class="sourceCode r"><code class="sourceCode r">t</code></pre>
<pre><code>## &lt;task&gt;
##   Public:
##     clone: function (deep = FALSE)
##     context_id: function ()
##     db: environment
##     expr: function (locals = FALSE)
##     handle: task_handle
##     id: 0a9f2bf4dcc74b7cabf41a19263e6b46
##     initialize: function (obj, id, check_exists = TRUE)
##     log: function ()
##     result: function (sanitise = FALSE)
##     status: function ()
##     times: function (unit_elapsed = &quot;secs&quot;)
##     wait: function (timeout, every = 0.5, progress = TRUE)</code></pre>
<p>the task’s status</p>
<pre class="sourceCode r"><code class="sourceCode r">t$<span class="kw">status</span>()</code></pre>
<pre><code>## [1] &quot;PENDING&quot;</code></pre>
<p>…which will move from <code>PENDING</code> to <code>RUNNING</code> to <code>COMPLETE</code> or <code>ERROR</code>. You can get information on submission and running times</p>
<pre class="sourceCode r"><code class="sourceCode r">t$<span class="kw">times</span>()</code></pre>
<pre><code>##                            task_id           submitted started finished
## 1 0a9f2bf4dcc74b7cabf41a19263e6b46 2016-05-27 12:09:29    &lt;NA&gt;     &lt;NA&gt;
##     waiting running idle
## 1 0.6493144      NA   NA</code></pre>
<p>and you can try and get the result of running the task:</p>
<pre class="sourceCode r"><code class="sourceCode r">t$<span class="kw">result</span>()</code></pre>
<pre><code>## Error: task 0a9f2bf4dcc74b7cabf41a19263e6b46 is unfetchable: PENDING</code></pre>
<p>The <code>wait</code> function, used above, is like <code>result</code> but it will repeatedly poll for the task to be completed for up to <code>timeout</code> seconds.</p>
<pre class="sourceCode r"><code class="sourceCode r">t$<span class="kw">wait</span>(<span class="dv">100</span>)</code></pre>
<pre><code>##
## Phylogenetic tree with 10 tips and 9 internal nodes.
##
## Tip labels:
##  t8, t6, t10, t5, t2, t3, ...
##
## Rooted; includes branch lengths.</code></pre>
<p>once the task has completed, <code>t$result()</code> and <code>t$wait</code> are equivalent</p>
<pre class="sourceCode r"><code class="sourceCode r">t$<span class="kw">result</span>()</code></pre>
<pre><code>##
## Phylogenetic tree with 10 tips and 9 internal nodes.
##
## Tip labels:
##  t8, t6, t10, t5, t2, t3, ...
##
## Rooted; includes branch lengths.</code></pre>
<p>Every task creates a log:</p>
<pre class="sourceCode r"><code class="sourceCode r">t$<span class="kw">log</span>()</code></pre>
<pre><code>## [ bootstrap ]  Q:\cluster_test\vignette\contexts
## [ lib       ]  Q:\cluster_test\vignette\contexts/R/x86_64-w64-mingw32/3.2.4
## [ ok        ]
## [ init      ]  2016-05-27 12:09:48.801
## [ hostname  ]  FI--DIDEMRC20
## [ version   ]  0.0.8
## [ parallel  ]  running as single core job
## [ root      ]  Q:\cluster_test\vignette\contexts
## [ task      ]  0a9f2bf4dcc74b7cabf41a19263e6b46
## [ context   ]  b7b2d57d4b3f6346d4d4f82fddb6040a
## [ lib       ]  Q:\cluster_test\vignette\contexts/R/x86_64-w64-mingw32/3.2.4
## [ library   ]  ape
## [ namespace ]
## [ source    ]  mysources.R
## [ expr      ]  make_tree(10)
## [ start     ]  2016-05-27 12:09:48.988
##     I am building a tree!
## [ ok        ]
## [ end       ]  2016-05-27 12:09:49.051
##     Warning message:
##     package 'ape' was built under R version 3.2.5</code></pre>
<p>Warning messages and other output will be printed here. So if you include <code>message()</code>, <code>cat()</code> or <code>print()</code> calls in your task they will appear between <code>start</code> and <code>end</code>.</p>
<p>There is another bit of log that happens before this and contains information about getting the system started up. You should only need to look at this when a job seems to get stuck with status <code>PENDING</code> for ages.</p>
<pre class="sourceCode r"><code class="sourceCode r">obj$<span class="kw">dide_log</span>(t)</code></pre>
<pre><code>## generated on host: wpia-dide136.dide.ic.ac.uk
## generated on date: 2016-05-27 12:09:29
## didewin version: 0.0.3
## context version: 0.0.8
## running on: FI--DIDEMRC20
## this is a single task
## mapping Q: -&gt; \\fi--san02\homes\rfitzjoh
## The command completed successfully.
## mapping T: -&gt; \\fi--didef2\tmp
## The command completed successfully.
## working directory: Q:\cluster_test\vignette
## logfile: Q:\cluster_test\vignette\contexts\logs\0a9f2bf4dcc74b7cabf41a19263e6b46
## Q:\cluster_test\vignette&gt;Rscript &quot;Q:\cluster_test\vignette\contexts\bin\context_runner&quot; &quot;Q:\cluster_test\vignette\contexts&quot; 0a9f2bf4dcc74b7cabf41a19263e6b46  1&gt;&quot;Q:\cluster_test\vignette\contexts\logs\0a9f2bf4dcc74b7cabf41a19263e6b46&quot; 2&gt;&amp;1
## Quitting</code></pre>
<p>The queue knows which tasks it has created and you can list them:</p>
<pre class="sourceCode r"><code class="sourceCode r">obj$<span class="kw">tasks_list</span>()</code></pre>
<pre><code>## [1] &quot;0a9f2bf4dcc74b7cabf41a19263e6b46&quot; &quot;927f552345164e35a5bdae2cf263dcf6&quot;</code></pre>
<p>The long identifiers are random and are long enough that collisions are unlikely.</p>
<p>Notice that the task ran remotely but we never had to indicate which filename things were written to. There is a small database based on <a href="https://richfitz.github.com/storr"><code>storr</code></a> that holds all the information within the context root (here, “contexts”). This means you can close down R and later on regenerate the <code>ctx</code> and <code>obj</code> objects and recreate the task objects, and re-get your results. But at the same time it provides the <em>illusion</em> that the cluster has passed an object directly back to you.</p>
<pre class="sourceCode r"><code class="sourceCode r">id &lt;-<span class="st"> </span>t$id
id</code></pre>
<pre><code>## [1] &quot;0a9f2bf4dcc74b7cabf41a19263e6b46&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">t2 &lt;-<span class="st"> </span>obj$<span class="kw">task_get</span>(id)
t2$<span class="kw">result</span>()</code></pre>
<pre><code>##
## Phylogenetic tree with 10 tips and 9 internal nodes.
##
## Tip labels:
##  t8, t6, t10, t5, t2, t3, ...
##
## Rooted; includes branch lengths.</code></pre>
</div>
<div id="running-many-jobs" class="section level2">
<h2>Running many jobs</h2>
<p>There are two broad options here;</p>
<ol style="list-style-type: decimal">
<li>Apply a function to each element of a list, similar to <code>lapply</code> with <code>queuer::qlapply</code></li>
<li>Apply a function to each row of a data.frame perhaps using each column as a different argument with <code>queuer::enqueue_bulk</code></li>
</ol>
<p>Suppose we want to make a bunch of trees of different sizes. This would involve mapping our <code>make_tree</code> function over a vector of sizes:</p>
<pre class="sourceCode r"><code class="sourceCode r">sizes &lt;-<span class="st"> </span><span class="dv">3</span>:<span class="dv">8</span>
grp &lt;-<span class="st"> </span>queuer::<span class="kw">qlapply</span>(sizes, make_tree, obj, <span class="dt">timeout=</span><span class="dv">0</span>)</code></pre>
<pre><code>## Creating bundle: 'displeasing_frog'</code></pre>
<pre><code>## saving 6 tasks...</code></pre>
<pre><code>## submitting 6 tasks...</code></pre>
<p>By default, <code>queuer::qlapply</code> returns a “task_bundle” with an automatically generated name. You can customise the name with the <code>name</code> argument.</p>
<p>Get the startus of all the jobs</p>
<pre class="sourceCode r"><code class="sourceCode r">grp$<span class="kw">status</span>()</code></pre>
<pre><code>## ff2bcd3a365146c48728c435edaa3861 2cf18f8ec8c74ab3ae3b430408bf1abf
##                       &quot;COMPLETE&quot;                       &quot;COMPLETE&quot;
## b02b441869eb4c35badb43f64f557a61 356d937b5a2a45f6a51ddfca88351835
##                       &quot;COMPLETE&quot;                       &quot;COMPLETE&quot;
## a3d94e773bab4a4e8fe49b5bfe942ed3 7e5439d00fd3403c88fab2680f116f62
##                        &quot;PENDING&quot;                        &quot;PENDING&quot;</code></pre>
<p>Wait until they are all complete and get the results</p>
<pre class="sourceCode r"><code class="sourceCode r">res &lt;-<span class="st"> </span>grp$<span class="kw">wait</span>(<span class="dv">120</span>)</code></pre>
<p>The other bulk interface is where you want to run a function over a combination of parameters. Use <code>queuer::enqueue_bulk</code> here.</p>
<pre class="sourceCode r"><code class="sourceCode r">pars &lt;-<span class="st"> </span><span class="kw">expand.grid</span>(<span class="dt">a=</span>letters[<span class="dv">1</span>:<span class="dv">3</span>], <span class="dt">b=</span><span class="kw">runif</span>(<span class="dv">2</span>), <span class="dt">c=</span>pi, <span class="dt">stringsAsFactors=</span><span class="ot">FALSE</span>)
pars</code></pre>
<pre><code>##   a         b        c
## 1 a 0.5728534 3.141593
## 2 b 0.5728534 3.141593
## 3 c 0.5728534 3.141593
## 4 a 0.9082078 3.141593
## 5 b 0.9082078 3.141593
## 6 c 0.9082078 3.141593</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">grp &lt;-<span class="st"> </span>queuer::<span class="kw">enqueue_bulk</span>(obj, pars, list, <span class="dt">do.call=</span><span class="ot">FALSE</span>, <span class="dt">timeout=</span><span class="dv">0</span>)</code></pre>
<pre><code>## Creating bundle: 'crazy_tsetsefly'</code></pre>
<pre><code>## saving 6 tasks...</code></pre>
<pre><code>## submitting 6 tasks...</code></pre>
<p>By default this runs</p>
<ul>
<li><code>list(a=pars$a[[1]], b=pars$b[[1]], c=pars$c[[1]])</code></li>
<li><code>list(a=pars$a[[2]], b=pars$b[[2]], c=pars$c[[2]])</code></li>
<li>…</li>
<li><code>list(a=pars$a[[6]], b=pars$b[[6]], c=pars$c[[6]])</code></li>
</ul>
<pre class="sourceCode r"><code class="sourceCode r">res &lt;-<span class="st"> </span>grp$<span class="kw">wait</span>(<span class="dv">120</span>)
res</code></pre>
<pre><code>## [[1]]
## [[1]][[1]]
## [[1]][[1]]$a
## [1] &quot;a&quot;
##
## [[1]][[1]]$b
## [1] 0.5728534
##
## [[1]][[1]]$c
## [1] 3.141593
##
##
##
## [[2]]
## [[2]][[1]]
## [[2]][[1]]$a
## [1] &quot;b&quot;
##
## [[2]][[1]]$b
## [1] 0.5728534
##
## [[2]][[1]]$c
## [1] 3.141593
##
##
##
## [[3]]
## [[3]][[1]]
## [[3]][[1]]$a
## [1] &quot;c&quot;
##
## [[3]][[1]]$b
## [1] 0.5728534
##
## [[3]][[1]]$c
## [1] 3.141593
##
##
##
## [[4]]
## [[4]][[1]]
## [[4]][[1]]$a
## [1] &quot;a&quot;
##
## [[4]][[1]]$b
## [1] 0.9082078
##
## [[4]][[1]]$c
## [1] 3.141593
##
##
##
## [[5]]
## [[5]][[1]]
## [[5]][[1]]$a
## [1] &quot;b&quot;
##
## [[5]][[1]]$b
## [1] 0.9082078
##
## [[5]][[1]]$c
## [1] 3.141593
##
##
##
## [[6]]
## [[6]][[1]]
## [[6]][[1]]$a
## [1] &quot;c&quot;
##
## [[6]][[1]]$b
## [1] 0.9082078
##
## [[6]][[1]]$c
## [1] 3.141593</code></pre>
</div>
<div id="cancelling-and-stopping-jobs" class="section level2">
<h2>Cancelling and stopping jobs</h2>
<p>Suppose you fire off a bunch of jobs and realise that you have the wrong data or they’re all going to fail - you can stop them fairly easily.</p>
<p>Here’s a job that will run for an hour and return nothing:</p>
<pre class="sourceCode r"><code class="sourceCode r">t &lt;-<span class="st"> </span>obj$<span class="kw">enqueue</span>(<span class="kw">Sys.sleep</span>(<span class="dv">3600</span>))</code></pre>
<p>Wait for the job to start up:</p>
<pre class="sourceCode r"><code class="sourceCode r">while (t$<span class="kw">status</span>() ==<span class="st"> &quot;PENDING&quot;</span>) {
  <span class="kw">Sys.sleep</span>(.<span class="dv">5</span>)
}</code></pre>
<p>Now that it’s started it can be cancelled with the <code>$unsubmit</code> method:</p>
<pre class="sourceCode r"><code class="sourceCode r">obj$<span class="kw">unsubmit</span>(t$id)</code></pre>
<pre><code>## [1] &quot;OK&quot;</code></pre>
<p>unsubmitting multiple times is safe, and will have no effect.</p>
<pre class="sourceCode r"><code class="sourceCode r">obj$<span class="kw">unsubmit</span>(t$id)</code></pre>
<pre><code>## [1] &quot;NOT_RUNNING&quot;</code></pre>
<p>Note that the task is not actually deleted (see below); you can still get at the expression:</p>
<pre class="sourceCode r"><code class="sourceCode r">t$<span class="kw">expr</span>()</code></pre>
<pre><code>## Sys.sleep(3600)</code></pre>
<p>but you cannot retrieve results:</p>
<pre class="sourceCode r"><code class="sourceCode r">t$<span class="kw">result</span>()</code></pre>
<pre><code>## Error: task d61bccd2b6704e739ff700cbda689906 is unfetchable: CANCELLED</code></pre>
<p>The argument to <code>unsubmit</code> can be a vector. For example, to unsubmit a whole task bundle:</p>
<pre class="sourceCode r"><code class="sourceCode r">grp &lt;-<span class="st"> </span>queuer::<span class="kw">qlapply</span>(<span class="kw">rep</span>(<span class="dv">3600</span>, <span class="dv">4</span>), Sys.sleep, obj)</code></pre>
<pre><code>## Creating bundle: 'unsuspecting_nematode'</code></pre>
<pre><code>## saving 4 tasks...</code></pre>
<pre><code>## submitting 4 tasks...</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">obj$<span class="kw">unsubmit</span>(grp$ids)</code></pre>
<pre><code>## [1] &quot;OK&quot; &quot;OK&quot; &quot;OK&quot; &quot;OK&quot;</code></pre>
<div id="deleting-jobs" class="section level3">
<h3>Deleting jobs</h3>
<p>Deleting tasks is supported but it isn’t entirely encouraged. Not all of the functions behave well with missing tasks, so if you delete things and still have old task handles floating around you might get confusing results.</p>
<p>There is a delete method (<code>obj$delete</code>) that will delete a job, first unsubmitting it if it has been submitted. It takes a single id as an argument.</p>
</div>
</div>
</div>
<div id="misc" class="section level1">
<h1>Misc</h1>
<div id="jobs-that-require-compiled-code" class="section level2">
<h2>Jobs that require compiled code</h2>
<p>If you are running stan, or Rcpp with <code>sourceCpp</code> (in the latter case you <em>should</em> be using a package) you’ll need a working compiler. For rstan this is detected automatically. But in general, pass <code>rtools=TRUE</code> to <code>queue_didewin()</code>.</p>
</div>
<div id="parallel-computation-on-the-cluster" class="section level2">
<h2>Parallel computation on the cluster</h2>
<p>If you are running tasks that can use more than one core, you can request more resources for your task and use process level parallism with the <code>parallel</code> package. To request 8 cores, you could run:</p>
<pre class="sourceCode r"><code class="sourceCode r">didewin::<span class="kw">didewin_config</span>(<span class="dt">cores=</span><span class="dv">8</span>)</code></pre>
<p>When your task starts, 8 cores will be allocated to it and a <code>parallel</code> cluster will be created. You can use it with things like <code>parallel::parLapply</code>, specifying <code>cl</code> as <code>NULL</code>. So if within your cluster job you needed to apply function <code>f</code> to a each element of a list <code>x</code>, you could write:</p>
<pre class="sourceCode r"><code class="sourceCode r">run_f &lt;-<span class="st"> </span>function(x) {
  parallel::<span class="kw">parLapply</span>(<span class="ot">NULL</span>, x, f)
}
obj$<span class="kw">enqueue</span>(<span class="kw">run_f</span>(x))</code></pre>
<p>The parallel bits can be embedded within larger blocks of code. All functions in <code>parallel</code> that take <code>cl</code> as a first argument can be used. You do not need to (and should not) set up the cluster as this will happen automatically as the job starts.</p>
<p>Alternatively, if you want to control cluster creation (e.g., you are using software that does this for you) then, pass <code>parallel=FALSE</code> to the config call:</p>
<pre class="sourceCode r"><code class="sourceCode r">didewin::<span class="kw">didewin_config</span>(<span class="dt">cores=</span><span class="dv">8</span>, <span class="dt">parallel=</span><span class="ot">FALSE</span>)</code></pre>
<p>In this case you are responsible for setting up the cluster.</p>
<p>As an alternative to requesting cores, you can use a different job template:</p>
<pre class="sourceCode r"><code class="sourceCode r">didewin::<span class="kw">didewin_config</span>(<span class="dt">template=</span><span class="st">&quot;16Core&quot;</span>)</code></pre>
<pre><code>## &lt;didewin_config&gt;
##  - cluster: fi--didemrchnb
##  - credentials: ~/.smbcredentials
##  - username: rfitzjoh
##  - build_server: 129.31.25.12
##  - template: 16Core
##  - hpctools: FALSE
##  - resource:
##     - parallel: TRUE
##     - count: 1
##     - type: Nodes
##  - shares:
##     - home: (local) /home/rich/net/home =&gt; //fi--san02/homes/rfitzjoh =&gt; Q: (remote)
##     - temp: (local) /home/rich/net/temp =&gt; //fi--didef2/tmp =&gt; T: (remote)</code></pre>
<p>which will reserve you the entire node. Again, a cluster will be started with all availabe cores unless you also specify <code>parallel=FALSE</code>.</p>
</div>
<div id="rstan" class="section level2">
<h2><code>rstan</code></h2>
<p>To use parallel chains, do something like:</p>
<pre class="sourceCode r"><code class="sourceCode r">config &lt;-<span class="st"> </span>didewin::<span class="kw">didewin_config</span>(<span class="dt">cores=</span><span class="dv">4</span>, <span class="dt">parallel=</span><span class="ot">FALSE</span>)
obj &lt;-<span class="st"> </span>didewin::<span class="kw">queue_didewin</span>(ctx, config)</code></pre>
<p>to request four cores or</p>
<pre class="sourceCode r"><code class="sourceCode r">config &lt;-<span class="st"> </span>didewin::<span class="kw">didewin_config</span>(<span class="dt">wholenode=</span><span class="ot">TRUE</span>, <span class="dt">parallel=</span><span class="ot">FALSE</span>)
obj &lt;-<span class="st"> </span>didewin::<span class="kw">queue_didewin</span>(ctx, config)</code></pre>
<p>to request a whole node. The <code>parallel=FALSE</code> tells the system not to set up a cluster for use with the <code>parallel</code> pacakge. However, you’ll still need to specify options(mc.cores) appropriately and I don’t expose that yet…</p>
</div>
<div id="using-microsoft-hpc-tools" class="section level2">
<h2>Using Microsoft HPC tools</h2>
<p>This section is only relevant for Windows users who are used to using the Windows Job Manager software in Microsoft HPC Pack.</p>
<p>If you have used the cluster tools from windows before, then you may be used to seeing your name show up in the HPC job manager. By default if you submit jobs with this tool, you will not see that as they’re actually submitted by a process on the cluster but run <em>as</em> you. See the <a href="https://mrcdata.dide.ic.ac.uk/wiki/index.php/HPC_Web_Portal#Notes_for_Windows_Job_Manager_Users">cluster wiki</a> for more information.</p>
<p>If you want this behaviour back, <code>didewin</code> can be configured to use the HPC tools on your computer. Just run:</p>
<pre class="sourceCode r"><code class="sourceCode r">didewin::<span class="kw">didewin_config_global</span>(<span class="dt">hpctools=</span><span class="ot">TRUE</span>)</code></pre>
<p>or</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">options</span>(<span class="dt">didewin.hpctools=</span><span class="ot">TRUE</span>)</code></pre>
<p>before creating the queue, or run</p>
<pre class="sourceCode r"><code class="sourceCode r">obj &lt;-<span class="st"> </span>didewin::<span class="kw">queue</span>(ctx, <span class="dt">config=</span>didewin::<span class="kw">didewin_config</span>(<span class="dt">hpctools=</span><span class="ot">TRUE</span>))</code></pre>
<p>This is experimental but I welcome feedback.</p>
</div>
</div>
<div id="mapping-network-drives" class="section level1">
<h1>Mapping network drives</h1>
<p>For all operating systems, if you are on the wireless network you will need to connect to the VPN. If you can get on a wired network you’ll likely have a better time because the VPN and wireless network seems less stable in general. Instructions for setting up a VPN are <a href="https://www1.imperial.ac.uk/publichealth/departments/ide/it/remote">here</a></p>
<div id="windows" class="section level2">
<h2>Windows</h2>
<p>Your network drives are likely already mapped for you. In fact you should not even need to map drives as fully qualified network names (e.g. <code>//fi--didef2/tmp</code>) should work for you.</p>
</div>
<div id="mac-osx" class="section level2">
<h2>Mac OS/X</h2>
<p>In Finder, go to <code>Go -&gt; Connect to Server...</code> or press <code>Command-K</code>. In the address field write the name of the share you want to connect to. Useful ones are</p>
<ul>
<li><code>smb://fi--san02.dide.ic.ac.uk/homes/&lt;username&gt;</code> – your home share</li>
<li><code>smb://fi--didef2.dide.ic.ac.uk/tmp</code> – the temporary share</li>
</ul>
<p>At some point in the process you should get prompted for your username and password, but I can’t remember what that looks like.</p>
<p>These directories will be mounted at <code>/Volumes/&lt;username&gt;</code> and <code>/Volumes/tmp</code> (so the last bit of the filename will be used as the mountpoint within <code>Volumes</code>). There may be a better way of doing this, and the connection will not be restablished automatically so if anyone has a better way let me know.</p>
</div>
<div id="linux" class="section level2">
<h2>Linux</h2>
<p>This is what I have done for my computer and it seems to work, though it’s not incredibly fast. Full instructions are <a href="https://help.ubuntu.com/community/MountWindowsSharesPermanently">on the Ubuntu community wiki</a>.</p>
<p>First, install cifs-utils</p>
<pre><code>sudo apt-get install cifs-utils</code></pre>
<p>In your <code>/etc/fstab</code> file, add</p>
<pre><code>//fi--san02/homes/&lt;dide-username&gt; &lt;home-mount-point&gt; cifs uid=&lt;local-userid&gt;,gid=&lt;local-groupid&gt;,credentials=/home/&lt;local-username&gt;/.smbcredentials,domain=DIDE,sec=ntlmssp,iocharset=utf8 0  0
//fi--didef2/tmp &lt;tmp-mount-point&gt; cifs uid=&lt;local-userid&gt;,gid=&lt;local-groupid&gt;,credentials=/home/&lt;local-username&gt;/.smbcredentials,domain=DIDE,sec=ntlmssp,iocharset=utf8 0  0</code></pre>
<p>where:</p>
<ul>
<li><code>&lt;dide-username&gt;</code> is your dide username without the <code>DIDE\</code> bit.</li>
<li><code>&lt;local-username&gt;</code> is your local username (i.e., <code>echo $USER</code>).</li>
<li><code>&lt;local-userid&gt;</code> is your local numeric user id (i.e. <code>id -u $USER</code>)</li>
<li><code>&lt;local-groupid&gt;</code> is your local numeric group id (i.e. <code>id -g $USER</code>)</li>
<li><code>&lt;home-mount-point&gt;</code> is where you want your DIDE home directory mounted</li>
<li><code>&lt;tmp-mount-point&gt;</code> is where you want the DIDE temporary directory mounted</li>
</ul>
<p><strong>please back this file up before editing</strong>.</p>
<p>So for example, I have:</p>
<pre><code>//fi--san02/homes/rfitzjoh /home/rich/net/home cifs uid=1000,gid=1000,credentials=/home/rich/.smbcredentials,domain=DIDE,sec=ntlmssp,iocharset=utf8 0  0
//fi--didef2/tmp /home/rich/net/temp cifs uid=1000,gid=1000,credentials=/home/rich/.smbcredentials,domain=DIDE,sec=ntlmssp,iocharset=utf8 0  0</code></pre>
<p>The file <code>.smbcredentials</code> contains</p>
<pre><code>username=&lt;dide-username&gt;
password=&lt;dide-password&gt;</code></pre>
<p>and set this to be chmod 600 for a modicum of security, but be aware your password is stored in plaintext.</p>
<p>This set up is clearly insecure. I believe if you omit the credentials line you can have the system prompt you for a password interactively, but I’m not sure how that works with automatic mounting.</p>
<p>Finally, run</p>
<pre><code>mount -a</code></pre>
<p>to mount all drives and with any luck it will all work and you don’t have to do this until you get a new computer.</p>
</div>
</div>
<div id="running-out-of-place" class="section level1">
<h1>Running out of place</h1>
<p>The instructions above require that you are running on a network drive. This might be inconvenient for people who run off the private network (e.g., mac users) or where you want to run things on the cluster part way through a project and don’t want to copy everything over to a network drive.</p>
<p>In this case there is (experimental) support for running “out of place” where the interaction with the cluster happens in a different directory to where your R session is running and where your files reside. The wrinkle is getting the files you need synchronised.</p>
<p>To do the syncronisation we use <code>rsync</code> via the <a href="https://github.com/richfitz/syncr"><code>syncr</code></a> package. Install it with:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">install.packages</span>(<span class="st">&quot;syncr&quot;</span>,
                 <span class="dt">repos=</span><span class="kw">c</span>(<span class="dt">CRAN=</span><span class="st">&quot;https://cran.rstudio.com&quot;</span>,
                         <span class="dt">drat=</span><span class="st">&quot;https://richfitz.github.io/drat&quot;</span>))</code></pre>
<p>Then, when constructing the queue, you need to specify a working directory for the cluster that is on the shared drive.</p>
<pre class="sourceCode r"><code class="sourceCode r">workdir &lt;-<span class="st"> &quot;Q:/cluster/context&quot;</span>
didewin::<span class="kw">didewin_config_global</span>(<span class="dt">workdir=</span>workdir)</code></pre>
<p>When you construct the context, that needs to be on a network share, so you might write:</p>
<pre class="sourceCode r"><code class="sourceCode r">root &lt;-<span class="st"> </span><span class="kw">file.path</span>(workdir, <span class="st">&quot;contexts&quot;</span>)
ctx &lt;-<span class="st"> </span>context::<span class="kw">context_save</span>(root, <span class="dt">packages=</span><span class="st">&quot;ape&quot;</span>, <span class="dt">sources=</span><span class="st">&quot;mysources.R&quot;</span>)</code></pre>
<p>Then construct the queue as normal.</p>
<pre class="sourceCode r"><code class="sourceCode r">obj &lt;-<span class="st"> </span>didewin::<span class="kw">queue_didewin</span>(ctx)</code></pre>
<p>This will automatically syncronise the sources, copying them if they need updating.</p>
<p>If you had other files to synchronise they would be listed with the argument <code>sync</code> to <code>queue_didewin</code>. You can update the remote files by running</p>
<pre class="sourceCode r"><code class="sourceCode r">obj$<span class="kw">sync_files</span>()</code></pre>
<p>at any time.</p>
</div>
<div id="installation" class="section level1">
<h1>Installation</h1>
<p>There are quite a few packages here that are not on CRAN. The simplest way to install the required packages should be to run:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">install.packages</span>(<span class="st">&quot;didewin&quot;</span>,
                 <span class="dt">repos=</span><span class="kw">c</span>(<span class="dt">CRAN=</span><span class="st">&quot;https://cran.rstudio.com&quot;</span>,
                         <span class="dt">drat=</span><span class="st">&quot;https://richfitz.github.io/drat&quot;</span>))</code></pre>
<p>Alternatively, with devtools you can run:</p>
<pre class="sourceCode r"><code class="sourceCode r">devtools::<span class="kw">install_github</span>(<span class="kw">c</span>(
  <span class="st">&quot;richfitz/ids&quot;</span>,
  <span class="st">&quot;richfitz/syncr&quot;</span>,
  <span class="st">&quot;dide-tools/context&quot;</span>,
  <span class="st">&quot;richfitz/queuer&quot;</span>,
  <span class="st">&quot;dide-tools/didewin&quot;</span>))</code></pre>
<p>(if devtools is not install, install it with <code>install.packages(&quot;devtools&quot;)</code>)</p>
<p>When upgrading, be sure to run everything in a fresh R session.</p>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
